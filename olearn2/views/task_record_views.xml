<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- Tree view -->
    <record id="view_task_record_tree" model="ir.ui.view">
        <field name="name">olearn2.task.record.tree</field>
        <field name="model">olearn2.task.record</field>
        <field name="arch" type="xml">
            <tree decoration-danger="status=='assigned' and overdue==True"
                  decoration-warning="status=='submitted'"
                  decoration-success="status=='graded'">
                <field name="task_id" string="Task"/>
                <field name="student_id" string="Student" groups="olearn2.group_teacher"/>
                <field name="status" widget="badge" decoration-danger="status=='assigned'"
                       decoration-warning="status=='submitted'" decoration-success="status=='graded'"/>
                <field name="score"/>
                <field name="task_max_score" string="Max"/>
                <field name="task_due_date" string="Due Date"/>
                <field name="submission_date" groups="olearn2.group_teacher"/>
                <field name="overdue" invisible="1"/>
            </tree>
        </field>
    </record>

    <!-- Form view for Students -->
    <record id="view_task_record_form_student" model="ir.ui.view">
        <field name="name">olearn2.task.record.form.student</field>
        <field name="model">olearn2.task.record</field>
        <field name="priority">10</field>
        <field name="groups_id" eval="[(4, ref('olearn2.group_student'))]"/>
        <field name="arch" type="xml">
            <form string="Task">
                <header>
                    <button string="Submit Task"
                            name="action_submit"
                            type="object"
                            class="oe_highlight"
                            attrs="{'invisible': ['|', ('status', 'not in', ['assigned','returned']), ('submittable', '=', False)]}"/>
                    <field name="status" widget="statusbar" statusbar_visible="assigned,submitted,returned,graded"/>
                </header>

                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="task_name"/>
                        </h1>
                    </div>

                    <group>
                        <group>
                            <field name="task_due_date" readonly="1"/>
                            <field name="overdue" widget="boolean" readonly="1"
                                   attrs="{'invisible': [('overdue', '=', False)]}"/>
                        </group>
                        <group>
                            <field name="task_max_score" readonly="1"/>
                            <field name="score" readonly="1" attrs="{'invisible': [('status', 'not in', ['graded'])]}"/>
                            <field name="submission_date" readonly="1"
                                   attrs="{'invisible': [('status', '=', 'assigned')]}"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Instructions" name="instructions">
                            <field name="task_content" widget="html" readonly="1"/>
                        </page>
                        <page string="My Submission" name="submission">
                            <group>
                                <field name="submission_text" widget="html"
                                       placeholder="Write your submission here..."
                                       attrs="{'readonly': [('status', 'not in', ['assigned','returned'])]}"/>
                                <field name="attachment" filename="attachment_name"
                                       attrs="{'readonly': [('status', 'not in', ['assigned','returned'])]}"/>
                                <field name="teacher_note"
                                       attrs="{'invisible': [('status','!=','returned')]}"/>
                                <field name="attachment_name" invisible="1"/>
                                <field name="submittable" invisible="1"/>
                            </group>
                        </page>
                        <page string="Feedback" name="feedback"
                              attrs="{'invisible': [('status', 'not in', ['graded'])]}">
                            <group>
                                <field name="teacher_note" readonly="1"/>
                                <field name="graded_date" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Form view for Teachers -->
    <record id="view_task_record_form_teacher" model="ir.ui.view">
        <field name="name">olearn2.task.record.form.teacher</field>
        <field name="model">olearn2.task.record</field>
        <field name="priority">10</field>
        <field name="groups_id" eval="[(4, ref('olearn2.group_teacher'))]"/>
        <field name="arch" type="xml">
            <form string="Student Task">
                <header>
                    <button string="Return to Student"
                            name="action_return_to_student"
                            type="object"
                            class="oe_highlight"
                            attrs="{'invisible': [('status', '!=', 'submitted')]}"/>
                    <button string="Mark as Done"
                            name="action_mark_as_done"
                            type="object"
                            class="oe_highlight"
                            attrs="{'invisible': [('status', '!=', 'submitted')]}"/>
                    <field name="status" widget="statusbar" statusbar_visible="assigned,submitted,returned,graded"/>
                </header>

                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="task_name"/>
                        </h1>
                    </div>

                    <group>
                        <group>
                            <field name="task_id" readonly="1"/>
                            <field name="student_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="task_due_date" readonly="1"/>
                            <field name="submission_date" readonly="1"/>
                            <field name="overdue" widget="boolean" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Student Submission" name="submission">
                            <group>
                                <field name="submission_text" widget="html" readonly="1"/>
                                <field name="attachment" filename="attachment_name" readonly="1"/>
                                <field name="attachment_name" invisible="1"/>
                            </group>
                        </page>
                        <page string="Grading" name="grading">
                            <group>
                                <field name="score"/>
                                <field name="task_max_score" readonly="1"/>
                                <field name="teacher_note" placeholder="Provide feedback to the student..."/>
                                <field name="graded_date" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Kanban view for Students -->
    <record id="view_task_record_kanban_student" model="ir.ui.view">
        <field name="name">olearn2.task.record.kanban.student</field>
        <field name="model">olearn2.task.record</field>
        <field name="priority">5</field>
        <field name="groups_id" eval="[(4, ref('olearn2.group_student'))]"/>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="task_name"/>
                <field name="status"/>
                <field name="score"/>
                <field name="task_max_score"/>
                <field name="task_due_date"/>
                <field name="overdue"/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary">
                                        <strong>
                                            <field name="task_name"/>
                                        </strong>
                                    </div>
                                    <div class="o_secondary">
                                        <span t-if="record.status.raw_value == 'assigned'"
                                              class="badge"
                                              t-att-class="record.overdue.raw_value ? 'badge-danger' : 'badge-warning'">
                                            <t t-if="record.overdue.raw_value">
                                                <i class="fa fa-exclamation-triangle"/>
                                                Overdue
                                            </t>
                                            <t t-else="">
                                                <i class="fa fa-clock-o"/>
                                                To Do
                                            </t>
                                        </span>
                                        <span t-if="record.status.raw_value == 'submitted'" class="badge badge-info">
                                            <i class="fa fa-check"/>
                                            Submitted
                                        </span>
                                        <span t-if="record.status.raw_value == 'graded'" class="badge badge-success">
                                            <i class="fa fa-trophy"/>
                                            Graded
                                        </span>
                                        <span t-if="record.status.raw_value == 'returned'" class="badge badge-info">
                                            <i class="fa fa-arrow-left"/>
                                            Returned
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="o_kanban_card_body">
                                <div>
                                    <i class="fa fa-calendar"/>
                                    Due:
                                    <field name="task_due_date"/>
                                </div>
                                <div t-if="record.status.raw_value == 'graded'" class="mt-1">
                                    <i class="fa fa-star"/>
                                    Score:<field name="score"/>/
                                    <field name="task_max_score"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Search view -->
    <record id="view_task_record_search" model="ir.ui.view">
        <field name="name">olearn2.task.record.search</field>
        <field name="model">olearn2.task.record</field>
        <field name="arch" type="xml">
            <search>
                <field name="task_id"/>
                <field name="student_id" groups="olearn2.group_teacher"/>

                <filter string="To Do" name="todo"
                        domain="['|', ('status', '=', 'assigned'), ('status', '=', 'returned')]"/>
                <filter string="Submitted" name="submitted" domain="[('status', '=', 'submitted')]"/>
                <filter string="Graded" name="graded" domain="[('status', '=', 'graded')]"/>

                <separator/>
                <filter string="Overdue" name="overdue" domain="[('overdue', '=', True)]"/>

                <group expand="0" string="Group By">
                    <filter string="Status" name="group_status" context="{'group_by': 'status'}"/>
                    <filter string="Student" name="group_student" context="{'group_by': 'student_id'}"
                            groups="olearn2.group_teacher"/>
                    <filter string="Task" name="group_task" context="{'group_by': 'task_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Actions -->
    <record id="action_task_record_teacher" model="ir.actions.act_window">
        <field name="name">Student Tasks</field>
        <field name="res_model">olearn2.task.record</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_task_record_search"/>
        <field name="context">{'search_default_submitted': 1, 'search_default_group_student': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No student task records found.
            </p>
        </field>
    </record>

    <!-- Explicit view bindings for teacher action -->
    <record id="action_task_record_teacher_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="view_task_record_tree"/>
        <field name="act_window_id" ref="action_task_record_teacher"/>
    </record>

    <record id="action_task_record_teacher_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_task_record_form_teacher"/>
        <field name="act_window_id" ref="action_task_record_teacher"/>
    </record>

    <record id="action_task_record_student" model="ir.actions.act_window">
        <field name="name">My Tasks</field>
        <field name="res_model">olearn2.task.record</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="search_view_id" ref="view_task_record_search"/>
        <field name="domain">[('student_id','=',uid),('task_id.hidden','=',False)]</field>
        <field name="context">{'search_default_todo': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                You don't have any tasks yet.
            </p>
            <p>
                Join a program to get started!
            </p>
        </field>
    </record>

    <!-- Explicit view bindings for student action -->
    <record id="action_task_record_student_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="view_task_record_kanban_student"/>
        <field name="act_window_id" ref="action_task_record_student"/>
    </record>

    <record id="action_task_record_student_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="view_task_record_tree"/>
        <field name="act_window_id" ref="action_task_record_student"/>
    </record>

    <record id="action_task_record_student_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="3"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_task_record_form_student"/>
        <field name="act_window_id" ref="action_task_record_student"/>
    </record>

</odoo>